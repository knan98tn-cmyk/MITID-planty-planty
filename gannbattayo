#include <RotaryEncoder.h>
#include <Adafruit_GFX.h>
#include <Adafruit_ST7789.h>
#include <SPI.h>
#include <Adafruit_seesaw.h>

//ロータリー
#define PIN_ENCODER_A A0
#define PIN_ENCODER_B A1
#define BUTTON_IN     7

RotaryEncoder encoder(PIN_ENCODER_A, PIN_ENCODER_B, RotaryEncoder::LatchMode::TWO03);

//スクリーン
#define TFT_CS  10
#define TFT_RST 9
#define TFT_DC  8

Adafruit_ST7789 screen(TFT_CS, TFT_DC, TFT_RST);


Adafruit_seesaw ss;

//色
#define BLACK   0x0000
#define WHITE   0xFFFF
#define YELLOW  0xFFE0
#define CYAN    0x07FF
#define RED     0xF800
#define GREEN   0x07E0

//
enum Page {
  PAGE_START,
  PAGE_CONDITION,
  PAGE_SETTING
};

Page currentPage = PAGE_START;
unsigned long pageTimer = 0;

/* ================= PLANT PROFILE ================= */
struct PlantProfile {
  const char* name;
  uint16_t moistMin;
  uint16_t moistMax;
  float tempMin;
  float tempMax;
};

// seesaw実測前提の例
PlantProfile plants[6] = {
  {"Type:A",     200, 350, 20.0, 35.0},
  {"Type:B",  250, 400, 18.0, 30.0},
  {"Type:C",    500, 750, 18.0, 28.0},
  {"Type:D",       450, 700, 15.0, 25.0},
  {"Type:E",      600, 850, 18.0, 26.0},
  {"Type:F",     300, 600, 15.0, 30.0}
};

int settingIndex = 0;
int selectedType = 0;

//bar range
#define MOIST_MIN 300
#define MOIST_MAX 900
#define TEMP_MIN  0
#define TEMP_MAX  40

//set-up
void setup() {
  Serial.begin(9600);

  pinMode(BUTTON_IN, INPUT_PULLUP);

  screen.init(240, 320);
  screen.setRotation(0);
  screen.fillScreen(BLACK);

  if (!ss.begin(0x36)) {
    Serial.println("seesaw not found");
  }

  pageTimer = millis();
}

//loop
void loop() {
  
  encoder.tick();

  switch (currentPage) {

    case PAGE_START:
      drawStartPage();
      if (millis() - pageTimer > 3000) {
        currentPage = PAGE_CONDITION;
        screen.fillScreen(BLACK);
      }
      break;

    case PAGE_CONDITION:
      drawConditionPage();

      if (digitalRead(BUTTON_IN) == LOW) {
        delay(1000);
        encoder.setPosition(settingIndex);
        currentPage = PAGE_SETTING;
        screen.fillScreen(BLACK);
      }
      break;

    case PAGE_SETTING:
      handleSettingPage();
      break;
  }
}

/* ================= DRAW FUNCTIONS ================= */

void drawStartPage() {
  screen.fillScreen(GREEN);
  screen.setTextColor(WHITE);
  screen.setTextSize(3);
  screen.setCursor(30, 140);
  screen.print("START");
}

/* -------- BAR DRAW -------- */
void drawBar(int x, int y, int w, int h,
             float value, float minV, float maxV,
             uint16_t color) {

  value = constrain(value, minV, maxV);
  int fillW = map(value, minV, maxV, 0, w);

  screen.drawRect(x, y, w, h, WHITE);
  if (fillW > 2) {
    screen.fillRect(x + 1, y + 1, fillW - 2, h - 2, color);
  }
}

/* -------- CONDITION -------- */
void drawConditionPage() {
  screen.fillScreen(BLACK);

  float temperature = ss.getTemp();
  uint16_t moisture = ss.analogRead(0);

  PlantProfile p = plants[selectedType];

  screen.setTextSize(2);
  screen.setTextColor(CYAN);

  screen.setCursor(10, 10);
  screen.print(p.name);

  // Moisture
  screen.setCursor(10, 40);
  screen.print("Moist:");
  screen.setCursor(160, 40);
  screen.print(moisture);

  drawBar(
    10, 65, 220, 16,
    moisture, MOIST_MIN, MOIST_MAX,
    (moisture >= p.moistMin && moisture <= p.moistMax) ? GREEN : RED
  );

  screen.setCursor(10, 85);
  screen.print("OK ");
  screen.print(p.moistMin);
  screen.print("-");
  screen.print(p.moistMax);

  // Temperature
  screen.setCursor(10, 120);
  screen.print("Temp:");
  screen.setCursor(160, 120);
  screen.print(temperature, 1);
  screen.print("C");

  drawBar(
    10, 145, 220, 16,
    temperature, TEMP_MIN, TEMP_MAX,
    (temperature >= p.tempMin && temperature <= p.tempMax) ? GREEN : RED
  );

  screen.setCursor(10, 165);
  screen.print("OK ");
  screen.print(p.tempMin);
  screen.print("-");
  screen.print(p.tempMax);

  bool ok =
    moisture >= p.moistMin && moisture <= p.moistMax &&
    temperature >= p.tempMin && temperature <= p.tempMax;

  screen.setCursor(10, 200);
  screen.setTextColor(ok ? GREEN : RED);
  screen.print(ok ? "STATUS: OK" : "STATUS: NG");

  // SETTING
  screen.fillRect(40, 250, 160, 40, WHITE);
  screen.setTextColor(BLACK);
  screen.setCursor(75, 265);
  screen.print("SETTING");
}

/* -------- SETTING -------- */
void handleSettingPage() {
  static int lastPos = 0;

  int pos = encoder.getPosition();
  if (pos != lastPos) {
    settingIndex += (pos > lastPos) ? 1 : -1;
    settingIndex = constrain(settingIndex, 0, 5);
    encoder.setPosition(settingIndex);
    lastPos = pos;
    screen.fillScreen(BLACK);
  }

  drawSettingPage();

  if (digitalRead(BUTTON_IN) == LOW) {
    delay(1000);
    selectedType = settingIndex;
    currentPage = PAGE_CONDITION;
    screen.fillScreen(BLACK);
  }
}

void drawSettingPage() {
  screen.setTextSize(2);

  for (int i = 0; i < 6; i++) {
    int y = 40 + i * 30;
    screen.setCursor(20, y);
    screen.setTextColor(WHITE);
    screen.print(plants[i].name);
  }

  screen.fillRect(0, 38 + settingIndex * 30, 240, 28, YELLOW);
}
